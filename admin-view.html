// Update User All Records
    function updateUserAllRecords() {
      if (!currentSelectedUser || !currentSelectedClass) return;
      
      const allSignOutsList = document.getElementById('user-all-signouts');
      const allSignInsList = document.getElementById('user-all-signins');
      
      // Clear previous entries
      allSignOutsList.innerHTML = '';
      allSignInsList.innerHTML = '';
      
      // Filter all records for the selected user and class
      const userSignOuts = userData.signOutRecords.filter(record => 
        record.user === currentSelectedUser && record.class === currentSelectedClass
      );
      
      const userSignIns = userData.signInRecords.filter(record => 
        record.user === currentSelectedUser && record.class === currentSelectedClass
      );
      
      // Add all sign-out records
      if (userSignOuts.length > 0) {
        userSignOuts.sort((a, b) => b.date - a.date); // Sort by date descending
        
        userSignOuts.forEach((record) => {
          const li = document.createElement('li');
          li.className = 'sign-out';
          
          const contentDiv = document.createElement('div');
          
          let endDateText = '';
          if (record.endDate) {
            if (getDateString(record.date) === getDateString(record.endDate)) {
              endDateText = ' until end of day';
            } else {
              endDateText = ` until ${formatDate(record.endDate)}`;
            }
          }
          
          if (record.isRecurring) {
            endDateText += ' (Weekly)';
          }
          
          const status = record.signedBackIn ? ' (Signed back in)' : '';
          
          contentDiv.innerHTML = `${formatDate(record.date)} at ${formatTime(record.date)}${endDateText}${status}`;
          
          // Add reason if exists
          if (record.reason) {
            const reasonDiv = document.createElement('div');
            reasonDiv.className = 'reason-tag';
            reasonDiv.textContent = `Reason: ${record.reason}`;
            contentDiv.appendChild(reasonDiv);
          }
          
          li.appendChild(contentDiv);
          allSignOutsList.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.textContent = 'No sign-out records found.';
        allSignOutsList.appendChild(li);
      }
      
      // Add all sign-in records
      if (userSignIns.length > 0) {
        userSignIns.sort((a, b) => b.date - a.date); // Sort by date descending
        
        userSignIns.forEach(record => {
          const li = document.createElement('li');
          li.className = 'sign-in';
          li.textContent = `${formatDate(record.date)} at ${formatTime(record.date)}`;
          allSignInsList.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.textContent = 'No sign-in records found.';
        allSignInsList.appendChild(li);
      }
    }
    
    // Change Stats Month
    function changeStatsMonth(offset) {
      if (offset === 0) {
        statsMonth = new Date();
      } else {
        statsMonth = new Date(statsMonth);
        statsMonth.setMonth(statsMonth.getMonth() + offset);
      }
      document.getElementById('stats-current-month').textContent = formatMonth(statsMonth);
      // Here you would update any month-specific charts or visualizations
    }
    
    // Update Stats
    function updateStats() {
      const now = new Date();
      
      // Filter function for class selection
      const classFilter = (record) => {
        if (selectedClass === "all") return true;
        return record.class === selectedClass;
      };
      
      // Calculate total users
      const uniqueUsers = new Set();
      userData.signOutRecords.filter(classFilter).forEach(record => {
        uniqueUsers.add(`${record.user}_${record.class || ''}`);
      });
      userData.signInRecords.filter(classFilter).forEach(record => {
        uniqueUsers.add(`${record.user}_${record.class || ''}`);
      });
      
      // Calculate total sign-outs
      const totalSignOuts = userData.signOutRecords.filter(classFilter).length;
      
      // Calculate currently signed out
      const currentlySignedOut = userData.signOutRecords.filter(record => 
        classFilter(record) &&
        record.date <= now && 
        (!record.endDate || record.endDate >= now) && 
        !record.signedBackIn
      ).length;
      
      // Calculate average sign-outs per day
      let avgSignOuts = 0;
      const filteredSignOuts = userData.signOutRecords.filter(classFilter);
      
      if (filteredSignOuts.length > 0) {
        // Get the earliest and latest dates
        const dates = filteredSignOuts.map(record => record.date.getTime());
        const earliestDate = new Date(Math.min(...dates));
        const latestDate = new Date(Math.max(...dates));
        
        // Calculate days between
        const daysDiff = Math.max(1, Math.ceil((latestDate - earliestDate) / (1000 * 60 * 60 * 24)));
        
        avgSignOuts = (filteredSignOuts.length / daysDiff).toFixed(1);
      }
      
      // Update the DOM
      document.getElementById('total-users').textContent = uniqueUsers.size;
      document.getElementById('total-signouts').textContent = totalSignOuts;
      document.getElementById('current-signouts').textContent = currentlySignedOut;
      document.getElementById('avg-signouts').textContent = avgSignOuts;
    }
    
    // Confirm Delete User
    function confirmDeleteUser(username, userClass) {
      if (confirm(`Are you sure you want to delete all data for ${username} (${userClass})? This action cannot be undone.`)) {
        deleteUserData(username, userClass);
      }
    }
    
    // Delete User Data
    function deleteUserData(username, userClass) {
      if (!username || !userClass) return;
      
      // Remove all user's records with matching class
      userData.signOutRecords = userData.signOutRecords.filter(record => 
        !(record.user === username && record.class === userClass)
      );
      
      userData.signInRecords = userData.signInRecords.filter(record => 
        !(record.user === username && record.class === userClass)
      );
      
      // Save to Firebase
      saveData();
      
      // If viewing user details, go back to list
      if (currentSelectedUser === username && currentSelectedClass === userClass) {
        backToUserList();
      }
      
      // Update UI
      populateUserList();
      updateStats();
      
      alert(`All data for ${username} (${userClass}) has been deleted.`);
    }
    
    // Confirm Delete User Data from details view
    function confirmDeleteUserData() {
      if (currentSelectedUser && currentSelectedClass && 
          confirm(`Are you sure you want to delete all data for ${currentSelectedUser} (${currentSelectedClass})? This action cannot be undone.`)) {
        deleteUserData(currentSelectedUser, currentSelectedClass);
      }
    }
    
    // Confirm Clear All Data
    function confirmClearAllData() {
      if (confirm("WARNING: Are you sure you want to delete ALL data from the system? This will remove all users and records. This action cannot be undone.")) {
        if (confirm("This is your final warning. All data will be permanently deleted. Continue?")) {
          clearAllData();
        }
      }
    }
    
    // Clear All Data
    function clearAllData() {
      // Reset data
      userData = {
        signOutRecords: [],
        signInRecords: []
      };
      
      // Save to Firebase
      saveData();
      
      // Update UI
      populateUserList();
      updateStats();
      
      // Go back to users tab
      showTab('users');
      
      alert("All system data has been deleted.");
    }
    
    // Export All Data
    function exportAllData() {
      const dataStr = JSON.stringify(userData, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileName = `ez-signout-export-${new Date().toISOString().split('T')[0]}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileName);
      linkElement.click();
    }
    
    // Save data to Firestore
    function saveData() {
      try {
        // Create a serializable copy
        const serializableData = JSON.parse(JSON.stringify(userData));
        
        // Save to Firestore
        db.collection('signOutApp').doc('userData').set(serializableData);
      } catch (error) {
        console.error("Error saving data:", error);
      }
    }
    
    // Set up real-time updates
    function setupRealtimeUpdates() {
      db.collection('signOutApp').doc('userData')
        .onSnapshot((doc) => {
          if (doc.exists) {
            const data = doc.data();
            
            // Convert string dates back to Date objects
            if (data.signOutRecords) {
              data.signOutRecords.forEach(record => {
                record.date = new Date(record.date);
                if (record.endDate) record.endDate = new Date(record.endDate);
              });
            }
            
            if (data.signInRecords) {
              data.signInRecords.forEach(record => {
                record.date = new Date(record.date);
              });
            }
            
            // Update our userData with the new data
            userData = data;
            
            // Update the UI
            populateUserList();
            updateStats();
            
            // Update user details if viewing
            if (currentSelectedUser && currentSelectedClass) {
              updateUserStats(currentSelectedUser, currentSelectedClass);
              if (userDetailView === 'calendar') {
                updateUserDetailCalendar();
              } else {
                updateUserAllRecords();
              }
            }
          }
        });
    }
    
    // Initialize on page load
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin View - EZ Sign-Out</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <!-- Initialize Firebase -->
  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAEfc8pQ0UHiIm9XQSYbKgI2IhOuP1w0do",
      authDomain: "ez-signout-b1f95.firebaseapp.com",
      projectId: "ez-signout-b1f95",
      storageBucket: "ez-signout-b1f95.firebasestorage.app",
      messagingSenderId: "747672158416",
      appId: "1:747672158416:web:dbf4f85c5acfb5c9785ed5"
    };
  
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
  <style>
    /* Apple-inspired styling */
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600&display=swap');
    
    :root {
      --primary-color: #0071e3; /* Apple blue */
      --secondary-color: #34c759; /* Apple green */
      --accent-color: #FF9500; /* Apple orange */
      --danger-color: #ff3b30; /* Apple red */
      --text-color: #1d1d1f; /* Apple dark gray */
      --secondary-text-color: #86868b; /* Apple medium gray */
      --background-color: #ffffff;
      --background-secondary: #f5f5f7; /* Apple light gray */
      --border-color: #d2d2d7;
      --signout-color: #ff3b30; /* Apple red */
      --signin-color: #34c759; /* Apple green */
      --border-radius: 12px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      --button-radius: 20px;
      --animation-duration: 0.3s;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text-color);
      background-color: var(--background-color);
      margin: 0;
      padding: 0;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
    }
    
    .wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    h1 {
      font-size: 32px;
      font-weight: 600;
      letter-spacing: -0.015em;
      margin-bottom: 24px;
    }
    
    h2 {
      font-size: 24px;
      font-weight: 500;
      letter-spacing: -0.012em;
      margin-bottom: 16px;
      margin-top: 24px;
    }
    
    h3 {
      font-size: 20px;
      font-weight: 500;
      letter-spacing: -0.01em;
      margin-bottom: 12px;
    }
    
    /* Container styling */
    .container {
      background-color: var(--background-color);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 30px;
      margin-bottom: 20px;
      width: 100%;
      position: relative;
    }
    
    /* Button styling */
    button {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--background-secondary);
      color: var(--text-color);
      border: none;
      border-radius: var(--button-radius);
      padding: 12px 20px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-duration);
      margin: 4px;
      outline: none;
    }
    
    button:hover {
      background-color: #eaeaea;
      transform: translateY(-1px);
    }
    
    button:active {
      transform: translateY(1px);
    }
    
    button.active {
      background-color: var(--primary-color);
      color: white;
    }
    
    .primary-button {
      background-color: var(--primary-color);
      color: white;
    }
    
    .primary-button:hover {
      background-color: #0077ed;
    }
    
    .secondary-button {
      background-color: var(--background-secondary);
    }
    
    .danger-button {
      background-color: var(--danger-color);
      color: white;
    }
    
    .danger-button:hover {
      background-color: #ff453a;
    }
    
    /* Class indicator badge */
    .class-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      color: white;
      margin-left: 6px;
    }
    
    .class-12K {
      background-color: #34c759; /* Green */
    }
    
    .class-13W {
      background-color: #0071e3; /* Blue */
    }
    
    .class-13B {
      background-color: #ff9500; /* Orange */
    }
    
    /* Reason tag */
    .reason-tag {
      display: block;
      background-color: rgba(0, 113, 227, 0.1);
      color: var(--primary-color);
      font-size: 13px;
      padding: 4px 10px;
      border-radius: 6px;
      margin-top: 8px;
      max-width: fit-content;
    }
    
    /* Navigation tabs */
    .nav-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 24px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .nav-tabs button {
      background-color: transparent;
      color: var(--secondary-text-color);
      border-radius: 0;
      padding: 12px 20px;
      margin: 0;
      position: relative;
    }
    
    .nav-tabs button.active {
      color: var(--primary-color);
      background-color: transparent;
      font-weight: 600;
    }
    
    .nav-tabs button.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background-color: var(--primary-color);
    }
    
    /* Class filter */
    .class-filter {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .class-filter label {
      font-weight: 500;
      color: var(--text-color);
      font-size: 15px;
    }
    
    .class-filter select {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 8px 16px;
      font-size: 15px;
      border-radius: var(--button-radius);
      border: 1px solid var(--border-color);
      outline: none;
      transition: border-color var(--animation-duration);
      background-color: var(--background-secondary);
    }
    
    .class-filter select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.15);
    }
    
    /* User list */
    .user-list {
      list-style-type: none;
      margin: 20px 0;
    }
    
    .user-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-radius: var(--border-radius);
      background-color: var(--background-secondary);
      margin-bottom: 12px;
      transition: all var(--animation-duration);
    }
    
    .user-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .user-info {
      flex-grow: 1;
    }
    
    .user-name {
      font-weight: 500;
      font-size: 18px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
    }
    
    .user-stats {
      color: var(--secondary-text-color);
      font-size: 14px;
    }
    
    .user-actions {
      display: flex;
      gap: 8px;
    }
    
    .action-button {
      font-size: 14px;
      padding: 8px 16px;
      border-radius: 16px;
    }
    
    /* Calendar styling */
    .calendar-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    
    .calendar-nav button {
      padding: 8px 16px;
      font-size: 14px;
    }
    
    .current-date {
      font-weight: 500;
      font-size: 18px;
      text-align: center;
      flex-grow: 1;
      order: -1;
      width: 100%;
      margin-bottom: 12px;
    }
    
    /* User details view */
    .user-details-container {
      margin-top: 24px;
    }
    
    .back-button {
      background-color: var(--background-secondary);
      color: var(--text-color);
      border-radius: 20px;
      font-size: 14px;
      padding: 8px 16px;
      display: inline-flex;
      align-items: center;
      margin-bottom: 16px;
      transition: all var(--animation-duration);
    }
    
    .back-button:hover {
      background-color: #eaeaea;
      transform: translateY(-1px);
    }
    
    .back-button::before {
      content: '←';
      margin-right: 6px;
    }
    
    /* Calendar styling */
    .monthly-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 20px;
    }
    
    .day-header {
      text-align: center;
      font-weight: 500;
      padding: 8px;
      color: var(--secondary-text-color);
      font-size: 14px;
    }
    
    .calendar-day {
      position: relative;
      min-height: 60px;
      padding: 6px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all var(--animation-duration);
    }
    
    .calendar-day:hover {
      background-color: rgba(0, 0, 0, 0.02);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }
    
    .calendar-day.today {
      background-color: #e4f5fe;
      border-color: var(--primary-color);
    }
    
    .calendar-day.other-month {
      opacity: 0.5;
    }
    
    .calendar-day.has-events::after {
      content: "";
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: var(--signout-color);
    }
    
    .day-number {
      text-align: right;
      font-size: 14px;
    }
    
    /* Calendar event items */
    .calendar-event {
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: white;
    }
    
    .event-12K {
      background-color: #34c759;
    }
    
    .event-13W {
      background-color: #0071e3;
    }
    
    .event-13B {
      background-color: #ff9500;
    }
    
    /* Records */
    ul {
      list-style-type: none;
      padding: 0;
      margin-bottom: 30px;
    }
    
    li {
      padding: 16px;
      margin-bottom: 12px;
      border-radius: var(--border-radius);
      background-color: var(--background-secondary);
      position: relative;
      transition: all var(--animation-duration);
    }
    
    li:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    #sign-out-list li, #user-detail-signout-list li, #user-all-signouts li {
      border-left: 4px solid var(--signout-color);
    }
    
    #sign-in-list li, #user-detail-signin-list li, #user-all-signins li {
      border-left: 4px solid var(--signin-color);
    }
    
    /* View toggle */
    .view-toggle {
      display: flex;
      border-radius: var(--button-radius);
      overflow: hidden;
      background-color: var(--background-secondary);
      margin-bottom: 24px;
      width: fit-content;
    }
    
    .view-toggle button {
      background-color: transparent;
      color: var(--secondary-text-color);
      border-radius: 0;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      margin: 0;
    }
    
    .view-toggle button.active {
      background-color: white;
      color: var(--text-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    /* Stats section */
    .stats-section {
      margin-bottom: 30px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    
    .stat-card {
      background-color: var(--background-secondary);
      border-radius: var(--border-radius);
      padding: 20px;
      text-align: center;
      box-shadow: var(--shadow);
      transition: all var(--animation-duration);
    }
    
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 600;
      margin: 10px 0;
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--secondary-text-color);
    }
    
    /* Search */
    .search-container {
      margin-bottom: 20px;
    }
    
    .search-input {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      background-color: var(--background-secondary);
      margin-bottom: 16px;
      transition: all var(--animation-duration);
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.15);
    }
    
    /* Class indicator legend */
    .class-legend {
      display: flex;
      gap: 16px;
      margin: 16px 0;
      flex-wrap: wrap;
    }
    
    .class-legend-item {
      display: flex;
      align-items: center;
      font-size: 14px;
    }
    
    .class-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
    }
    
    /* Utilities */
    .hidden {
      display: none !important;
    }
    
    /* Responsive */
    @media (max-width: 767px) {
      .wrapper {
        padding: 16px;
      }
      
      .container {
        padding: 20px;
      }
      
      h1 {
        font-size: 28px;
      }
      
      .user-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .user-actions {
        margin-top: 12px;
        width: 100%;
        justify-content: flex-end;
      }
      
      .nav-tabs {
        justify-content: space-between;
      }
      
      .nav-tabs button {
        padding: 12px 10px;
        font-size: 14px;
      }
      
      .action-button {
        padding: 6px 12px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="container">
      <h1>Admin Dashboard</h1>
      
      <!-- Admin Tabs -->
      <div class="nav-tabs">
        <button id="users-tab" class="active" onclick="showTab('users')">All Users</button>
        <button id="stats-tab" onclick="showTab('stats')">Statistics</button>
        <button id="settings-tab" onclick="showTab('settings')">Settings</button>
      </div>
      
      <!-- Class Filter -->
      <div class="class-filter">
        <label for="class-select">Filter by Class:</label>
        <select id="class-select" onchange="filterByClass()">
          <option value="all">All Classes</option>
          <option value="12K">12K</option>
          <option value="13W">13W</option>
          <option value="13B">13B</option>
        </select>
      </div>
      
      <!-- Stats Section -->
      <div id="stats-content" class="tab-content hidden">
        <div class="stats-section">
          <div class="stat-card">
            <div class="stat-label">Total Sign-Outs</div>
            <div class="stat-value" id="user-total-signouts">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Sign-Out Status</div>
            <div class="stat-value" id="user-status">Signed In</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Last Activity</div>
            <div class="stat-value" id="user-last-activity">Never</div>
          </div>
        </div>
        
        <div class="view-toggle">
          <button id="user-detail-calendar-btn" onclick="setUserDetailView('calendar')" class="active">Calendar</button>
          <button id="user-detail-records-btn" onclick="setUserDetailView('records')">All Records</button>
        </div>
        
        <!-- User Calendar View -->
        <div id="user-detail-calendar-view">
          <div class="calendar-nav">
            <button onclick="changeUserDetailDate(-1)">Previous Day</button>
            <div class="current-date" id="user-detail-date"></div>
            <button onclick="changeUserDetailDate(0)">Today</button>
            <button onclick="changeUserDetailDate(1)">Next Day</button>
          </div>
          
          <h3>Sign-Out Records</h3>
          <ul id="user-detail-signout-list">
            <!-- Sign-out logs will go here -->
          </ul>
          
          <h3>Sign-In Records</h3>
          <ul id="user-detail-signin-list">
            <!-- Sign-in logs will go here -->
          </ul>
        </div>
        
        <!-- User Records View -->
        <div id="user-detail-records-view" class="hidden">
          <h3>All Sign-Out Records</h3>
          <ul id="user-all-signouts">
            <!-- All user sign-outs will go here -->
          </ul>
          
          <h3>All Sign-In Records</h3>
          <ul id="user-all-signins">
            <!-- All user sign-ins will go here -->
          </ul>
          
          <div style="margin-top: 30px;">
            <button class="danger-button" onclick="confirmDeleteUserData()">Delete User Data</button>
            <p style="margin-top: 10px; color: var(--secondary-text-color);">Warning: This will delete all records for this user. This action cannot be undone.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Data storage
    let userData = {
      signOutRecords: [],
      signInRecords: []
    };
    
    let currentSelectedUser = "";
    let currentSelectedClass = "";
    let userDetailDate = new Date();
    let statsMonth = new Date();
    let userDetailView = "calendar";
    let selectedClass = "all"; // Default to showing all classes
    
    // Initialize the app
    async function init() {
      // Set dates to today
      const today = new Date();
      userDetailDate = new Date(today);
      statsMonth = new Date(today);
      
      document.getElementById("user-detail-date").textContent = formatDate(userDetailDate);
      document.getElementById("stats-current-month").textContent = formatMonth(statsMonth);
      
      try {
        // Load data from Firestore
        const docRef = db.collection('signOutApp').doc('userData');
        const doc = await docRef.get();
        
        if (doc.exists) {
          const data = doc.data();
          
          // Convert string dates back to Date objects
          if (data.signOutRecords) {
            data.signOutRecords.forEach(record => {
              record.date = new Date(record.date);
              if (record.endDate) record.endDate = new Date(record.endDate);
            });
          }
          
          if (data.signInRecords) {
            data.signInRecords.forEach(record => {
              record.date = new Date(record.date);
            });
          }
          
          userData = data;
          
          // Populate user list
          populateUserList();
          updateStats();
          
          // Set up real-time updates
          setupRealtimeUpdates();
        } else {
          // Initialize with empty data if document doesn't exist
          userData = {
            signOutRecords: [],
            signInRecords: []
          };
          
          // Create the document
          await docRef.set(userData);
          populateUserList();
        }
      } catch (error) {
        console.error("Error loading data:", error);
        
        // Fallback to empty data
        userData = {
          signOutRecords: [],
          signInRecords: []
        };
        
        populateUserList();
      }
    }
    
    // Format date for display
    function formatDate(date) {
      return date.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    }
    
    // Format month for display
    function formatMonth(date) {
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long'
      });
    }
    
    // Format time for display
    function formatTime(date) {
      return date.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }
    
    // Format date for comparison
    function getDateString(date) {
      return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
    }
    
    // Filter by class
    function filterByClass() {
      selectedClass = document.getElementById("class-select").value;
      populateUserList();
      updateStats();
    }
    
    // Show Tab
    function showTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
      });
      
      // Show selected tab content
      document.getElementById(`${tabName}-content`).classList.remove('hidden');
      
      // Update tab button states
      document.querySelectorAll('.nav-tabs button').forEach(button => {
        button.classList.remove('active');
      });
      document.getElementById(`${tabName}-tab`).classList.add('active');
      
      // Hide user details if showing a different tab
      if (tabName !== 'users') {
        document.getElementById('user-details').classList.add('hidden');
      }
    }
    
    // Populate User List
    function populateUserList() {
      const userList = document.getElementById('user-list');
      userList.innerHTML = '';
      
      // Create a map to store unique user+class combinations
      const userClassMap = new Map();
      
      // Process sign-out records
      userData.signOutRecords.forEach(record => {
        if (record.user && record.class) {
          // Apply class filter if selected
          if (selectedClass !== "all" && record.class !== selectedClass) {
            return;
          }
          
          const key = `${record.user}_${record.class}`;
          if (!userClassMap.has(key)) {
            userClassMap.set(key, {
              user: record.user,
              class: record.class,
              signOuts: 0,
              signIns: 0,
              lastActivity: null
            });
          }
          
          const userInfo = userClassMap.get(key);
          userInfo.signOuts++;
          
          // Update last activity
          const activityDate = record.date.getTime();
          if (!userInfo.lastActivity || activityDate > userInfo.lastActivity) {
            userInfo.lastActivity = activityDate;
          }
        }
      });
      
      // Process sign-in records
      userData.signInRecords.forEach(record => {
        if (record.user && record.class) {
          // Apply class filter if selected
          if (selectedClass !== "all" && record.class !== selectedClass) {
            return;
          }
          
          const key = `${record.user}_${record.class}`;
          if (!userClassMap.has(key)) {
            userClassMap.set(key, {
              user: record.user,
              class: record.class,
              signOuts: 0,
              signIns: 0,
              lastActivity: null
            });
          }
          
          const userInfo = userClassMap.get(key);
          userInfo.signIns++;
          
          // Update last activity
          const activityDate = record.date.getTime();
          if (!userInfo.lastActivity || activityDate > userInfo.lastActivity) {
            userInfo.lastActivity = activityDate;
          }
        }
      });
      
      // Convert Map to Array and sort alphabetically first by class, then by username
      const userClassArray = Array.from(userClassMap.values()).sort((a, b) => {
        if (a.class !== b.class) {
          return a.class.localeCompare(b.class);
        }
        return a.user.localeCompare(b.user);
      });
      
      if (userClassArray.length === 0) {
        userList.innerHTML = '<li class="user-item">No users found.</li>';
        return;
      }
      
      // Create list items for each user-class combination
      userClassArray.forEach(userInfo => {
        // Check if user is currently signed out
        const now = new Date();
        const isSignedOut = userData.signOutRecords.some(record => 
          record.user === userInfo.user && 
          record.class === userInfo.class &&
          record.date <= now && 
          (!record.endDate || record.endDate >= now) && 
          !record.signedBackIn
        );
        
        // Create user item
        const li = document.createElement('li');
        li.className = 'user-item';
        
        const userNameDiv = document.createElement('div');
        userNameDiv.className = 'user-name';
        userNameDiv.textContent = userInfo.user;
        
        // Add class badge
        const classBadge = document.createElement('span');
        classBadge.className = `class-badge class-${userInfo.class}`;
        classBadge.textContent = userInfo.class;
        userNameDiv.appendChild(classBadge);
        
        const userStatsDiv = document.createElement('div');
        userStatsDiv.className = 'user-stats';
        
        let statsText = `${userInfo.signOuts} sign-outs, ${userInfo.signIns} sign-ins`;
        if (userInfo.lastActivity) {
          const lastActivityDate = new Date(userInfo.lastActivity);
          statsText += ` · Last activity: ${formatDate(lastActivityDate)}`;
        }
        
        if (isSignedOut) {
          statsText += ' · <span style="color: var(--signout-color); font-weight: 500;">Currently signed out</span>';
        }
        
        userStatsDiv.innerHTML = statsText;
        
        const userInfoDiv = document.createElement('div');
        userInfoDiv.className = 'user-info';
        userInfoDiv.appendChild(userNameDiv);
        userInfoDiv.appendChild(userStatsDiv);
        
        const userActionsDiv = document.createElement('div');
        userActionsDiv.className = 'user-actions';
        
        const viewDetailsBtn = document.createElement('button');
        viewDetailsBtn.className = 'action-button primary-button';
        viewDetailsBtn.textContent = 'View Details';
        viewDetailsBtn.onclick = function() {
          viewUserDetails(userInfo.user, userInfo.class);
        };
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'action-button danger-button';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = function() {
          confirmDeleteUser(userInfo.user, userInfo.class);
        };
        
        userActionsDiv.appendChild(viewDetailsBtn);
        userActionsDiv.appendChild(deleteBtn);
        
        li.appendChild(userInfoDiv);
        li.appendChild(userActionsDiv);
        userList.appendChild(li);
      });
    }
    
    // Search Users
    function searchUsers() {
      const searchTerm = document.getElementById('user-search').value.toLowerCase();
      const userItems = document.getElementById('user-list').getElementsByTagName('li');
      
      for (let i = 0; i < userItems.length; i++) {
        const userName = userItems[i].querySelector('.user-name');
        if (userName) {
          const text = userName.textContent || userName.innerText;
          if (text.toLowerCase().indexOf(searchTerm) > -1) {
            userItems[i].style.display = '';
          } else {
            userItems[i].style.display = 'none';
          }
        }
      }
    }
    
    // View User Details
    function viewUserDetails(username, userClass) {
      currentSelectedUser = username;
      currentSelectedClass = userClass;
      
      // Hide user list and show user details
      document.getElementById('users-content').classList.add('hidden');
      document.getElementById('user-details').classList.remove('hidden');
      
      // Set user name and class
      document.getElementById('user-detail-name').textContent = username;
      document.getElementById('user-detail-class').textContent = `Class: ${userClass}`;
      
      // Update user statistics
      updateUserStats(username, userClass);
      
      // Set default view
      setUserDetailView('calendar');
      
      // Update calendar or records view
      updateUserDetailCalendar();
      updateUserAllRecords();
    }
    
    // Update User Statistics
    function updateUserStats(username, userClass) {
      const userSignOuts = userData.signOutRecords.filter(record => 
        record.user === username && record.class === userClass
      );
      
      // Update sign-out count
      document.getElementById('user-total-signouts').textContent = userSignOuts.length;
      
      // Check if user is currently signed out
      const now = new Date();
      const isSignedOut = userSignOuts.some(record => 
        record.date <= now && 
        (!record.endDate || record.endDate >= now) && 
        !record.signedBackIn
      );
      
      // Update sign-out status
      const statusElement = document.getElementById('user-status');
      statusElement.textContent = isSignedOut ? 'Signed Out' : 'Signed In';
      statusElement.style.color = isSignedOut ? 'var(--signout-color)' : 'var(--signin-color)';
      
      // Get last activity date
      const userSignIns = userData.signInRecords.filter(record => 
        record.user === username && record.class === userClass
      );
      
      let lastActivity = null;
      const allUserRecords = [...userSignOuts, ...userSignIns];
      if (allUserRecords.length > 0) {
        lastActivity = new Date(Math.max(...allUserRecords.map(record => record.date.getTime())));
        document.getElementById('user-last-activity').textContent = formatDate(lastActivity);
      } else {
        document.getElementById('user-last-activity').textContent = 'Never';
      }
    }
    
    // Back to User List
    function backToUserList() {
      document.getElementById('users-content').classList.remove('hidden');
      document.getElementById('user-details').classList.add('hidden');
      currentSelectedUser = "";
      currentSelectedClass = "";
    }
    
    // Set User Detail View (Calendar or Records)
    function setUserDetailView(view) {
      userDetailView = view;
      
      if (view === 'calendar') {
        document.getElementById('user-detail-calendar-view').classList.remove('hidden');
        document.getElementById('user-detail-records-view').classList.add('hidden');
        document.getElementById('user-detail-calendar-btn').classList.add('active');
        document.getElementById('user-detail-records-btn').classList.remove('active');
        updateUserDetailCalendar();
      } else {
        document.getElementById('user-detail-calendar-view').classList.add('hidden');
        document.getElementById('user-detail-records-view').classList.remove('hidden');
        document.getElementById('user-detail-calendar-btn').classList.remove('active');
        document.getElementById('user-detail-records-btn').classList.add('active');
        updateUserAllRecords();
      }
    }
    
    // Change the date for the user detail calendar
    function changeUserDetailDate(offset) {
      if (offset === 0) {
        userDetailDate = new Date();
      } else {
        userDetailDate = new Date(userDetailDate);
        userDetailDate.setDate(userDetailDate.getDate() + offset);
      }
      document.getElementById('user-detail-date').textContent = formatDate(userDetailDate);
      updateUserDetailCalendar();
    }
    
    // Update User Detail Calendar
    function updateUserDetailCalendar() {
      if (!currentSelectedUser || !currentSelectedClass) return;
      
      const signOutList = document.getElementById('user-detail-signout-list');
      const signInList = document.getElementById('user-detail-signin-list');
      
      // Clear previous entries
      signOutList.innerHTML = '';
      signInList.innerHTML = '';
      
      // Filter records for the selected user and date
      const dateStr = getDateString(userDetailDate);
      
      // Add sign-out records
      const signOutRecords = userData.signOutRecords.filter(record => {
        return record.user === currentSelectedUser && 
               record.class === currentSelectedClass &&
               (getDateString(record.date) === dateStr || 
                (record.endDate && record.date <= userDetailDate && record.endDate >= userDetailDate));
      });
      
      if (signOutRecords.length > 0) {
        signOutRecords.sort((a, b) => b.date - a.date); // Sort by date descending
        
        signOutRecords.forEach((record) => {
          const li = document.createElement('li');
          li.className = 'sign-out';
          
          const contentDiv = document.createElement('div');
          
          let endDateText = '';
          if (record.endDate) {
            if (getDateString(record.date) === getDateString(record.endDate)) {
              endDateText = ' until end of day';
            } else {
              endDateText = ` until ${formatDate(record.endDate)}`;
            }
          }
          
          if (record.isRecurring) {
            endDateText += ' (Weekly)';
          }
          
          const status = record.signedBackIn ? ' (Signed back in)' : '';
          
          contentDiv.innerHTML = `Signed out at ${formatTime(record.date)}${endDateText}${status}`;
          
          // Add reason if exists
          if (record.reason) {
            const reasonDiv = document.createElement('div');
            reasonDiv.className = 'reason-tag';
            reasonDiv.textContent = `Reason: ${record.reason}`;
            contentDiv.appendChild(reasonDiv);
          }
          
          li.appendChild(contentDiv);
          signOutList.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.textContent = 'No sign-out records for this day.';
        signOutList.appendChild(li);
      }
      
      // Add sign-in records
      const signInRecords = userData.signInRecords.filter(record => {
        return record.user === currentSelectedUser && 
               record.class === currentSelectedClass && 
               getDateString(record.date) === dateStr;
      });
      
      if (signInRecords.length > 0) {
        signInRecords.sort((a, b) => b.date - a.date); // Sort by date descending
        
        signInRecords.forEach(record => {
          const li = document.createElement('li');
          li.className = 'sign-in';
          li.textContent = `Signed back in at ${formatTime(record.date)}`;
          signInList.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.textContent = 'No sign-in records for this day.';
        signInList.appendChild(li);
      }
    } class="stat-label">Total Users</div>
            <div class="stat-value" id="total-users">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Sign-Outs</div>
            <div class="stat-value" id="total-signouts">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Currently Signed Out</div>
            <div class="stat-value" id="current-signouts">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Avg. Sign-Outs Per Day</div>
            <div class="stat-value" id="avg-signouts">0</div>
          </div>
        </div>
        
        <h2>Activity Over Time</h2>
        <div class="calendar-nav">
          <button onclick="changeStatsMonth(-1)">Previous Month</button>
          <div class="current-date" id="stats-current-month"></div>
          <button onclick="changeStatsMonth(0)">Current Month</button>
          <button onclick="changeStatsMonth(1)">Next Month</button>
        </div>
        
        <!-- Class Legend -->
        <div class="class-legend">
          <div class="class-legend-item">
            <span class="class-indicator class-12K"></span> 12K
          </div>
          <div class="class-legend-item">
            <span class="class-indicator class-13W"></span> 13W
          </div>
          <div class="class-legend-item">
            <span class="class-indicator class-13B"></span> 13B
          </div>
        </div>
        
        <!-- Activity chart placeholder -->
        <div id="activity-chart" style="height: 300px; background-color: var(--background-secondary); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center;">
          Activity Chart Placeholder
        </div>
      </div>
      
      <!-- Settings Section -->
      <div id="settings-content" class="tab-content hidden">
        <h2>Admin Settings</h2>
        
        <div style="margin-top: 20px;">
          <h3>Data Management</h3>
          <button class="danger-button" onclick="confirmClearAllData()">Clear All System Data</button>
          <p style="margin-top: 10px; color: var(--secondary-text-color);">Warning: This will delete all users and records from the system. This action cannot be undone.</p>
        </div>
        
        <div style="margin-top: 30px;">
          <h3>Export Data</h3>
          <button class="primary-button" onclick="exportAllData()">Export All Data</button>
          <p style="margin-top: 10px; color: var(--secondary-text-color);">Download a backup of all system data in JSON format.</p>
        </div>
      </div>
      
      <!-- Users List Section -->
      <div id="users-content" class="tab-content">
        <!-- Search -->
        <div class="search-container">
          <input type="text" id="user-search" class="search-input" placeholder="Search users..." onkeyup="searchUsers()">
        </div>
        
        <!-- User List -->
        <ul id="user-list" class="user-list">
          <!-- User items will be dynamically added here -->
        </ul>
      </div>
      
      <!-- User Details View -->
      <div id="user-details" class="user-details-container hidden">
        <button class="back-button" onclick="backToUserList()">Back to Users</button>
        
        <h2 id="user-detail-name">User Name</h2>
        <div id="user-detail-class" class="user-stats">Class: -</div>
        
        <div class="stats-section">
          <div class="stat-card">
            <div
