<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin View - EZ Sign-Out</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <style>
    /* Apple-inspired styling */
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600&display=swap');
    
    :root {
      --primary-color: #0071e3; /* Apple blue */
      --secondary-color: #34c759; /* Apple green */
      --accent-color: #FF9500; /* Apple orange */
      --danger-color: #ff3b30; /* Apple red */
      --text-color: #1d1d1f; /* Apple dark gray */
      --secondary-text-color: #86868b; /* Apple medium gray */
      --background-color: #ffffff;
      --background-secondary: #f5f5f7; /* Apple light gray */
      --border-color: #d2d2d7;
      --signout-color: #ff3b30; /* Apple red */
      --signin-color: #34c759; /* Apple green */
      --border-radius: 12px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      --button-radius: 20px;
      --animation-duration: 0.3s;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text-color);
      background-color: var(--background-color);
      margin: 0;
      padding: 0;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
    }
    
    .wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    h1 {
      font-size: 32px;
      font-weight: 600;
      letter-spacing: -0.015em;
      margin-bottom: 24px;
    }
    
    h2 {
      font-size: 24px;
      font-weight: 500;
      letter-spacing: -0.012em;
      margin-bottom: 16px;
      margin-top: 24px;
    }
    
    h3 {
      font-size: 20px;
      font-weight: 500;
      letter-spacing: -0.01em;
      margin-bottom: 12px;
    }
    
    /* Container styling */
    .container {
      background-color: var(--background-color);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 30px;
      margin-bottom: 20px;
      width: 100%;
      position: relative;
    }
    
    /* Button styling */
    button {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--background-secondary);
      color: var(--text-color);
      border: none;
      border-radius: var(--button-radius);
      padding: 12px 20px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-duration);
      margin: 4px;
      outline: none;
    }
    
    button:hover {
      background-color: #eaeaea;
      transform: translateY(-1px);
    }
    
    button:active {
      transform: translateY(1px);
    }
    
    button.active {
      background-color: var(--primary-color);
      color: white;
    }
    
    .primary-button {
      background-color: var(--primary-color);
      color: white;
    }
    
    .primary-button:hover {
      background-color: #0077ed;
    }
    
    .secondary-button {
      background-color: var(--background-secondary);
    }
    
    .danger-button {
      background-color: var(--danger-color);
      color: white;
    }
    
    .danger-button:hover {
      background-color: #ff453a;
    }
    
    /* Navigation tabs */
    .nav-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 24px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .nav-tabs button {
      background-color: transparent;
      color: var(--secondary-text-color);
      border-radius: 0;
      padding: 12px 20px;
      margin: 0;
      position: relative;
    }
    
    .nav-tabs button.active {
      color: var(--primary-color);
      background-color: transparent;
      font-weight: 600;
    }
    
    .nav-tabs button.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background-color: var(--primary-color);
    }
    
    /* User list */
    .user-list {
      list-style-type: none;
      margin: 20px 0;
    }
    
    .user-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-radius: var(--border-radius);
      background-color: var(--background-secondary);
      margin-bottom: 12px;
      transition: all var(--animation-duration);
    }
    
    .user-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .user-info {
      flex-grow: 1;
    }
    
    .user-name {
      font-weight: 500;
      font-size: 18px;
      margin-bottom: 4px;
    }
    
    .user-stats {
      color: var(--secondary-text-color);
      font-size: 14px;
    }
    
    .user-actions {
      display: flex;
      gap: 8px;
    }
    
    .action-button {
      font-size: 14px;
      padding: 8px 16px;
      border-radius: 16px;
    }
    
    /* Calendar styling */
    .calendar-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    
    .calendar-nav button {
      padding: 8px 16px;
      font-size: 14px;
    }
    
    .current-date {
      font-weight: 500;
      font-size: 18px;
      text-align: center;
      flex-grow: 1;
      order: -1;
      width: 100%;
      margin-bottom: 12px;
    }
    
    /* User details view */
    .user-details-container {
      margin-top: 24px;
    }
    
    .back-button {
      background-color: var(--background-secondary);
      color: var(--text-color);
      border-radius: 20px;
      font-size: 14px;
      padding: 8px 16px;
      display: inline-flex;
      align-items: center;
      margin-bottom: 16px;
      transition: all var(--animation-duration);
    }
    
    .back-button:hover {
      background-color: #eaeaea;
      transform: translateY(-1px);
    }
    
    .back-button::before {
      content: '‚Üê';
      margin-right: 6px;
    }
    
    /* Calendar styling */
    .monthly-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 20px;
    }
    
    .day-header {
      text-align: center;
      font-weight: 500;
      padding: 8px;
      color: var(--secondary-text-color);
      font-size: 14px;
    }
    
    .calendar-day {
      position: relative;
      min-height: 60px;
      padding: 6px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all var(--animation-duration);
    }
    
    .calendar-day:hover {
      background-color: rgba(0, 0, 0, 0.02);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }
    
    .calendar-day.today {
      background-color: #e4f5fe;
      border-color: var(--primary-color);
    }
    
    .calendar-day.other-month {
      opacity: 0.5;
    }
    
    .calendar-day.has-events::after {
      content: "";
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: var(--signout-color);
    }
    
    .day-number {
      text-align: right;
      font-size: 14px;
    }
    
    /* Records */
    ul {
      list-style-type: none;
      padding: 0;
      margin-bottom: 30px;
    }
    
    li {
      padding: 16px;
      margin-bottom: 12px;
      border-radius: var(--border-radius);
      background-color: var(--background-secondary);
      position: relative;
      transition: all var(--animation-duration);
    }
    
    li:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    #sign-out-list li, #user-detail-signout-list li, #user-all-signouts li {
      border-left: 4px solid var(--signout-color);
    }
    
    #sign-in-list li, #user-detail-signin-list li, #user-all-signins li {
      border-left: 4px solid var(--signin-color);
    }
    
    /* View toggle */
    .view-toggle {
      display: flex;
      border-radius: var(--button-radius);
      overflow: hidden;
      background-color: var(--background-secondary);
      margin-bottom: 24px;
      width: fit-content;
    }
    
    .view-toggle button {
      background-color: transparent;
      color: var(--secondary-text-color);
      border-radius: 0;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      margin: 0;
    }
    
    .view-toggle button.active {
      background-color: white;
      color: var(--text-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    /* Stats section */
    .stats-section {
      margin-bottom: 30px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    
    .stat-card {
      background-color: var(--background-secondary);
      border-radius: var(--border-radius);
      padding: 20px;
      text-align: center;
      box-shadow: var(--shadow);
      transition: all var(--animation-duration);
    }
    
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 600;
      margin: 10px 0;
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--secondary-text-color);
    }
    
    /* Search */
    .search-container {
      margin-bottom: 20px;
    }
    
    .search-input {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      background-color: var(--background-secondary);
      margin-bottom: 16px;
      transition: all var(--animation-duration);
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.15);
    }
    
    /* Loading indicator */
    .loading {
      text-align: center;
      padding: 20px;
      color: var(--secondary-text-color);
    }
    
    /* Utilities */
    .hidden {
      display: none !important;
    }
    
    /* Responsive */
    @media (max-width: 767px) {
      .wrapper {
        padding: 16px;
      }
      
      .container {
        padding: 20px;
      }
      
      h1 {
        font-size: 28px;
      }
      
      .user-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .user-actions {
        margin-top: 12px;
        width: 100%;
        justify-content: flex-end;
      }
      
      .nav-tabs {
        justify-content: space-between;
      }
      
      .nav-tabs button {
        padding: 12px 10px;
        font-size: 14px;
      }
      
      .action-button {
        padding: 6px 12px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="container">
      <h1>Admin Dashboard</h1>
      
      <!-- Admin Tabs -->
      <div class="nav-tabs">
        <button id="users-tab" class="active" onclick="showTab('users')">All Users</button>
        <button id="stats-tab" onclick="showTab('stats')">Statistics</button>
        <button id="settings-tab" onclick="showTab('settings')">Settings</button>
      </div>
      
      <!-- Loading Indicator -->
      <div id="loading" class="loading">
        Loading data...
      </div>
      
      <!-- Stats Section -->
      <div id="stats-content" class="tab-content hidden">
        <div class="stats-section">
          <div class="stat-card">
            <div class="stat-label">Total Users</div>
            <div class="stat-value" id="total-users">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Sign-Outs</div>
            <div class="stat-value" id="total-signouts">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Currently Signed Out</div>
            <div class="stat-value" id="current-signouts">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Avg. Sign-Outs Per Day</div>
            <div class="stat-value" id="avg-signouts">0</div>
          </div>
        </div>
        
        <h2>Activity Over Time</h2>
        <div class="calendar-nav">
          <button onclick="changeStatsMonth(-1)">Previous Month</button>
          <div class="current-date" id="stats-current-month"></div>
          <button onclick="changeStatsMonth(0)">Current Month</button>
          <button onclick="changeStatsMonth(1)">Next Month</button>
        </div>
        
        <!-- Activity chart would go here -->
        <div id="activity-chart" style="height: 300px; background-color: var(--background-secondary); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center;">
          Activity Chart Placeholder
        </div>
      </div>
      
      <!-- Settings Section -->
      <div id="settings-content" class="tab-content hidden">
        <h2>Admin Settings</h2>
        
        <div style="margin-top: 20px;">
          <h3>Data Management</h3>
          <button class="danger-button" onclick="confirmClearAllData()">Clear All System Data</button>
          <p style="margin-top: 10px; color: var(--secondary-text-color);">Warning: This will delete all users and records from the system. This action cannot be undone.</p>
        </div>
        
        <div style="margin-top: 30px;">
          <h3>Export Data</h3>
          <button class="primary-button" onclick="exportAllData()">Export All Data</button>
          <p style="margin-top: 10px; color: var(--secondary-text-color);">Download a backup of all system data in JSON format.</p>
        </div>
      </div>
      
      <!-- Users List Section -->
      <div id="users-content" class="tab-content hidden">
        <!-- Search -->
        <div class="search-container">
          <input type="text" id="user-search" class="search-input" placeholder="Search users..." onkeyup="searchUsers()">
        </div>
        
        <!-- User List -->
        <ul id="user-list" class="user-list">
          <!-- User items will be dynamically added here -->
        </ul>
      </div>
      
      <!-- User Details View -->
      <div id="user-details" class="user-details-container hidden">
        <button class="back-button" onclick="backToUserList()">Back to Users</button>
        
        <h2 id="user-detail-name">User Name</h2>
        
        <div class="stats-section">
          <div class="stat-card">
            <div class="stat-label">Total Sign-Outs</div>
            <div class="stat-value" id="user-total-signouts">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Sign-Out Status</div>
            <div class="stat-value" id="user-status">Signed In</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Last Activity</div>
            <div class="stat-value" id="user-last-activity">Never</div>
          </div>
        </div>
        
        <div class="view-toggle">
          <button id="user-detail-calendar-btn" onclick="setUserDetailView('calendar')" class="active">Calendar</button>
          <button id="user-detail-records-btn" onclick="setUserDetailView('records')">All Records</button>
        </div>
        
        <!-- User Calendar View -->
        <div id="user-detail-calendar-view">
          <div class="calendar-nav">
            <button onclick="changeUserDetailDate(-1)">Previous Day</button>
            <div class="current-date" id="user-detail-date"></div>
            <button onclick="changeUserDetailDate(0)">Today</button>
            <button onclick="changeUserDetailDate(1)">Next Day</button>
          </div>
          
          <h3>Sign-Out Records</h3>
          <ul id="user-detail-signout-list">
            <!-- Sign-out logs will go here -->
          </ul>
          
          <h3>Sign-In Records</h3>
          <ul id="user-detail-signin-list">
            <!-- Sign-in logs will go here -->
          </ul>
        </div>
        
        <!-- User Records View -->
        <div id="user-detail-records-view" class="hidden">
          <h3>All Sign-Out Records</h3>
          <ul id="user-all-signouts">
            <!-- All user sign-outs will go here -->
          </ul>
          
          <h3>All Sign-In Records</h3>
          <ul id="user-all-signins">
            <!-- All user sign-ins will go here -->
          </ul>
          
          <div style="margin-top: 30px;">
            <button class="danger-button" onclick="confirmDeleteUserData()">Delete User Data</button>
            <p style="margin-top: 10px; color: var(--secondary-text-color);">Warning: This will delete all records for this user. This action cannot be undone.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Import the User Data Manager -->
  <script type="module">
    // Import the data manager
    import userDataManager from './js/userDataManager.js';
    
    // Expose functions to make them accessible to inline event handlers
    window.showTab = showTab;
    window.viewUserDetails = viewUserDetails;
    window.backToUserList = backToUserList;
    window.setUserDetailView = setUserDetailView;
    window.changeUserDetailDate = changeUserDetailDate;
    window.changeStatsMonth = changeStatsMonth;
    window.searchUsers = searchUsers;
    window.confirmDeleteUserData = confirmDeleteUserData;
    window.confirmClearAllData = confirmClearAllData;
    window.exportAllData = exportAllData;
    
    // Store any active data listeners for cleanup
    let dataListener = null;
    
    // Current selected user and view state
    let currentSelectedUser = "";
    let userDetailDate = new Date();
    let statsMonth = new Date();
    let userDetailView = "calendar";
    
    // Initialize the app
    async function init() {
      try {
        // Show loading state
        document.getElementById('loading').style.display = 'block';
        document.getElementById('users-content').classList.add('hidden');
        document.getElementById('stats-content').classList.add('hidden');
        document.getElementById('settings-content').classList.add('hidden');
        
        // Set dates to today
        const today = new Date();
        userDetailDate = new Date(today);
        statsMonth = new Date(today);
        
        document.getElementById("user-detail-date").textContent = userDataManager.formatDate(userDetailDate);
        document.getElementById("stats-current-month").textContent = formatMonth(statsMonth);
        
        // Initialize data manager
        await userDataManager.initialize();
        
        // Hide loading, show users tab
        document.getElementById('loading').style.display = 'none';
        document.getElementById('users-content').classList.remove('hidden');
        
        // Populate user list
        populateUserList();
        
        // Update stats
        updateStats();
        
        // Set up real-time updates
        dataListener = userDataManager.addDataListener(() => {
          populateUserList();
          updateStats();
          
          // Update user details if viewing
          if (currentSelectedUser) {
            updateUserStats(currentSelectedUser);
            if (userDetailView === 'calendar') {
              updateUserDetailCalendar();
            } else {
              updateUserAllRecords();
            }
          }
        });
      } catch (error) {
        console.error("Error initializing:", error);
        document.getElementById('loading').textContent = "Error loading data. Please refresh the page.";
      }
    }
    
    // Format month for display
    function formatMonth(date) {
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long'
      });
    }
    
    // Show Tab
    function showTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
      });
      
      // Show selected tab content
      document.getElementById(`${tabName}-content`).classList.remove('hidden');
      
      // Update tab button states
      document.querySelectorAll('.nav-tabs button').forEach(button => {
        button.classList.remove('active');
      });
      document.getElementById(`${tabName}-tab`).classList.add('active');
      
      // Hide user details if showing a different tab
      if (tabName !== 'users') {
        document.getElementById('user-details').classList.add('hidden');
      }
    }
    
    // Populate User List
    function populateUserList() {
      const userList = document.getElementById('user-list');
      userList.innerHTML = '';
      
      // Get all users
      const usersArray = userDataManager.getAllUsers();
      
      if (usersArray.length === 0) {
        userList.innerHTML = '<li class="user-item">No users found.</li>';
        return;
      }
      
      // Create list items for each user
      usersArray.forEach(username => {
        const userSignOuts = userDataManager.getUserSignOutRecords(username);
        const userSignIns = userDataManager.getUserSignInRecords(username);
        
        // Check if user is currently signed out
        const isSignedOut = userDataManager.isUserSignedOut(username);
        
        // Get last activity date
        let lastActivity = null;
        const allUserRecords = [...userSignOuts, ...userSignIns];
        if (allUserRecords.length > 0) {
          lastActivity = new Date(Math.max(...allUserRecords.map(record => record.date.getTime())));
        }
        
        // Create user item
        const li = document.createElement('li');
        li.className = 'user-item';
        li.innerHTML = `
          <div class="user-info">
            <div class="user-name">${username}</div>
            <div class="user-stats">
              ${userSignOuts.length} sign-outs, ${userSignIns.length} sign-ins
              ${lastActivity ? `¬∑ Last activity: ${userDataManager.formatDate(lastActivity)}` : ''}
              ${isSignedOut ? '<span style="color: var(--signout-color); font-weight: 500;">¬∑ Currently signed out</span>' : ''}
            </div>
          </div>
          <div class="user-actions">
            <button class="action-button primary-button" onclick="viewUserDetails('${username}')">View Details</button>
            <button class="action-button danger-button" onclick="confirmDeleteUser('${username}')">Delete</button>
          </div>
        `;
        userList.appendChild(li);
      });
    }
    
    // Search Users
    function searchUsers() {
      const searchTerm = document.getElementById('user-search').value.toLowerCase();
      const userItems = document.getElementById('user-list').getElementsByTagName('li');
      
      for (let i = 0; i < userItems.length; i++) {
        const userName = userItems[i].querySelector('.user-name');
        if (userName) {
          const text = userName.textContent || userName.innerText;
          if (text.toLowerCase().indexOf(searchTerm) > -1) {
            userItems[i].style.display = '';
          } else {
            userItems[i].style.display = 'none';
          }
        }
      }
    }
    
    // Confirm Delete User
    function confirmDeleteUser(username) {
      if (confirm(`Are you sure you want to delete all data for user "${username}"? This action cannot be undone.`)) {
        deleteUserData(username);
      }
    }
    
    // Delete User Data
    async function deleteUserData(username) {
      if (!username) return;
      
      try {
        // Delete user data using the data manager
        await userDataManager.deleteUserData(username);
        
        // If viewing user details, go back to list
        if (currentSelectedUser === username) {
          backToUserList();
        }
        
        // Update UI
        populateUserList();
        updateStats();
        
        alert(`All data for user "${username}" has been deleted.`);
      } catch (error) {
        console.error("Error deleting user data:", error);
        alert("Failed to delete user data. Please try again.");
      }
    }
    
    // View User Details
    function viewUserDetails(username) {
      currentSelectedUser = username;
      
      // Hide user list and show user details
      document.getElementById('users-content').classList.add('hidden');
      document.getElementById('user-details').classList.remove('hidden');
      
      // Set user name
      document.getElementById('user-detail-name').textContent = username;
      
      // Update user statistics
      updateUserStats(username);
      
      // Set default view
      setUserDetailView('calendar');
      
      // Update calendar or records view
      updateUserDetailCalendar();
      updateUserAllRecords();
    }
    
    // Update User Statistics
    function updateUserStats(username) {
      const userSignOuts = userDataManager.getUserSignOutRecords(username);
      const userSignIns = userDataManager.getUserSignInRecords(username);
      
      // Update sign-out count
      document.getElementById('user-total-signouts').textContent = userSignOuts.length;
      
      // Check if user is currently signed out
      const isSignedOut = userDataManager.isUserSignedOut(username);
      
      // Update sign-out status
      document.getElementById('user-status').textContent = isSignedOut ? 'Signed Out' : 'Signed In';
      document.getElementById('user-status').style.color = isSignedOut ? 'var(--signout-color)' : 'var(--signin-color)';
      
      // Get last activity date
      let lastActivity = null;
      const allUserRecords = [...userSignOuts, ...userSignIns];
      if (allUserRecords.length > 0) {
        lastActivity = new Date(Math.max(...allUserRecords.map(record => record.date.getTime())));
        document.getElementById('user-last-activity').textContent = userDataManager.formatDate(lastActivity);
      } else {
        document.getElementById('user-last-activity').textContent = 'Never';
      }
    }
    
    // Back to User List
    function backToUserList() {
      document.getElementById('users-content').classList.remove('hidden');
      document.getElementById('user-details').classList.add('hidden');
      currentSelectedUser = "";
    }
    
    // Set User Detail View (Calendar or Records)
    function setUserDetailView(view) {
      userDetailView = view;
      
      if (view === 'calendar') {
        document.getElementById('user-detail-calendar-view').classList.remove('hidden');
        document.getElementById('user-detail-records-view').classList.add('hidden');
        document.getElementById('user-detail-calendar-btn').classList.add('active');
        document.getElementById('user-detail-records-btn').classList.remove('active');
        updateUserDetailCalendar();
      } else {
        document.getElementById('user-detail-calendar-view').classList.add('hidden');
        document.getElementById('user-detail-records-view').classList.remove('hidden');
        document.getElementById('user-detail-calendar-btn').classList.remove('active');
        document.getElementById('user-detail-records-btn').classList.add('active');
        updateUserAllRecords();
      }
    }
    
    // Change the date for the user detail calendar
    function changeUserDetailDate(offset) {
      if (offset === 0) {
        userDetailDate = new Date();
      } else {
        userDetailDate = new Date(userDetailDate);
        userDetailDate.setDate(userDetailDate.getDate() + offset);
      }
      document.getElementById('user-detail-date').textContent = userDataManager.formatDate(userDetailDate);
      updateUserDetailCalendar();
    }
    
    // Update User Detail Calendar
    function updateUserDetailCalendar() {
      if (!currentSelectedUser) return;
      
      const signOutList = document.getElementById('user-detail-signout-list');
      const signInList = document.getElementById('user-detail-signin-list');
      
      // Clear previous entries
      signOutList.innerHTML = '';
      signInList.innerHTML = '';
      
      // Get sign-out and sign-in records for the selected date and user
      const signOutRecords = userDataManager.getSignOutRecordsForDate(userDetailDate, currentSelectedUser);
      const signInRecords = userDataManager.getSignInRecordsForDate(userDetailDate, currentSelectedUser);
      
      // Add sign-out records
      if (signOutRecords.length > 0) {
        // Sort by date descending
        signOutRecords.sort((a, b) => b.date - a.date);
        
        signOutRecords.forEach((record) => {
          const li = document.createElement('li');
          li.className = 'sign-out';
          
          let endDateText = '';
          if (record.endDate) {
            if (userDataManager.getDateString(record.date) === userDataManager.getDateString(record.endDate)) {
              endDateText = ' until end of day';
            } else {
              endDateText = ` until ${userDataManager.formatDate(record.endDate)}`;
            }
          }
          
          if (record.isRecurring) {
            endDateText += ' (Weekly)';
          }
          
          const status = record.signedBackIn ? ' (Signed back in)' : '';
          
          li.textContent = `Signed out at ${userDataManager.formatTime(record.date)}${endDateText}${status}`;
          
          // Add comment if available
          if (record.comment) {
            const commentDiv = document.createElement('div');
            commentDiv.style.marginTop = '8px';
            commentDiv.style.fontStyle = 'italic';
            commentDiv.textContent = `Comment: "${record.comment}"`;
            li.appendChild(commentDiv);
          }
          
          signOutList.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.textContent = 'No sign-out records for this day.';
        signOutList.appendChild(li);
      }
      
      // Add sign-in records
      if (signInRecords.length > 0) {
        // Sort by date descending
        signInRecords.sort((a, b) => b.date - a.date);
        
        signInRecords.forEach(record => {
          const li = document.createElement('li');
          li.className = 'sign-in';
          li.textContent = `Signed back in at ${userDataManager.formatTime(record.date)}`;
          signInList.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.textContent = 'No sign-in records for this day.';
        signInList.appendChild(li);
      }
    }
    
    // Update User All Records
    function updateUserAllRecords() {
      if (!currentSelectedUser) return;
      
      const allSignOutsList = document.getElementById('user-all-signouts');
      const allSignInsList = document.getElementById('user-all-signins');
      
      // Clear previous entries
      allSignOutsList.innerHTML = '';
      allSignInsList.innerHTML = '';
      
      // Get all sign-out and sign-in records for the user
      const userSignOuts = userDataManager.getUserSignOutRecords(currentSelectedUser);
      const userSignIns = userDataManager.getUserSignInRecords(currentSelectedUser);
      
      // Add all sign-out records
      if (userSignOuts.length > 0) {
        // Sort by date descending
        userSignOuts.sort((a, b) => b.date - a.date);
        
        userSignOuts.forEach((record) => {
          const li = document.createElement('li');
          li.className = 'sign-out';
          
          let endDateText = '';
          if (record.endDate) {
            if (userDataManager.getDateString(record.date) === userDataManager.getDateString(record.endDate)) {
              endDateText = ' until end of day';
            } else {
              endDateText = ` until ${userDataManager.formatDate(record.endDate)}`;
            }
          }
          
          if (record.isRecurring) {
            endDateText += ' (Weekly)';
          }
          
          const status = record.signedBackIn ? ' (Signed back in)' : '';
          
          li.textContent = `${userDataManager.formatDate(record.date)} at ${userDataManager.formatTime(record.date)}${endDateText}${status}`;
          
          // Add comment if available
          if (record.comment) {
            const commentDiv = document.createElement('div');
            commentDiv.style.marginTop = '8px';
            commentDiv.style.fontStyle = 'italic';
            commentDiv.textContent = `Comment: "${record.comment}"`;
            li.appendChild(commentDiv);
          }
          
          allSignOutsList.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.textContent = 'No sign-out records found.';
        allSignOutsList.appendChild(li);
      }
      
      // Add all sign-in records
      if (userSignIns.length > 0) {
        // Sort by date descending
        userSignIns.sort((a, b) => b.date - a.date);
        
        userSignIns.forEach(record => {
          const li = document.createElement('li');
          li.className = 'sign-in';
          li.textContent = `${userDataManager.formatDate(record.date)} at ${userDataManager.formatTime(record.date)}`;
          allSignInsList.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.textContent = 'No sign-in records found.';
        allSignInsList.appendChild(li);
      }
    }
    
    // Change Stats Month
    function changeStatsMonth(offset) {
      if (offset === 0) {
        statsMonth = new Date();
      } else {
        statsMonth = new Date(statsMonth);
        statsMonth.setMonth(statsMonth.getMonth() + offset);
      }
      document.getElementById('stats-current-month').textContent = formatMonth(statsMonth);
      // Here you would update any month-specific charts or visualizations
    }
    
    // Update Stats
    function updateStats() {
      const now = new Date();
      
      // Calculate total users
      const uniqueUsers = userDataManager.getAllUsers().length;
      
      // Get all sign-out records
      const allSignOutRecords = userDataManager.getData().signOutRecords;
      
      // Calculate total sign-outs
      const totalSignOuts = allSignOutRecords.length;
      
      // Calculate currently signed out users
      let currentlySignedOut = 0;
      userDataManager.getAllUsers().forEach(username => {
        if (userDataManager.isUserSignedOut(username)) {
          currentlySignedOut++;
        }
      });
      
      // Calculate average sign-outs per day
      let avgSignOuts = 0;
      if (totalSignOuts > 0) {
        // Get the earliest and latest dates
        const dates = allSignOutRecords.map(record => record.date.getTime());
        const earliestDate = new Date(Math.min(...dates));
        const latestDate = new Date(Math.max(...dates));
        
        // Calculate days between
        const daysDiff = Math.max(1, Math.ceil((latestDate - earliestDate) / (1000 * 60 * 60 * 24)));
        
        avgSignOuts = (totalSignOuts / daysDiff).toFixed(1);
      }
      
      // Update the DOM
      document.getElementById('total-users').textContent = uniqueUsers;
      document.getElementById('total-signouts').textContent = totalSignOuts;
      document.getElementById('current-signouts').textContent = currentlySignedOut;
      document.getElementById('avg-signouts').textContent = avgSignOuts;
    }
    
    // Confirm Delete User Data from details view
    function confirmDeleteUserData() {
      if (currentSelectedUser && confirm(`Are you sure you want to delete all data for user "${currentSelectedUser}"? This action cannot be undone.`)) {
        deleteUserData(currentSelectedUser);
      }
    }
    
    // Confirm Clear All Data
    function confirmClearAllData() {
      if (confirm("WARNING: Are you sure you want to delete ALL data from the system? This will remove all users and records. This action cannot be undone.")) {
        if (confirm("This is your final warning. All data will be permanently deleted. Continue?")) {
          clearAllData();
        }
      }
    }
    
    // Clear All Data
    async function clearAllData() {
      try {
        // Clear all data using the data manager
        await userDataManager.clearAllData();
        
        // Update UI
        populateUserList();
        updateStats();
        
        // Go back to users tab
        showTab('users');
        
        alert("All system data has been deleted.");
      } catch (error) {
        console.error("Error clearing data:", error);
        alert("Failed to clear data. Please try again.");
      }
    }
    
    // Export All Data
    function exportAllData() {
      const dataStr = userDataManager.exportAllData();
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileName = `ez-signout-export-${new Date().toISOString().split('T')[0]}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileName);
      linkElement.click();
    }
    
    // Cleanup function for when page unloads
    function cleanup() {
      // Remove data listener
      if (dataListener) {
        dataListener();
      }
    }
    
    // Initialize on page load
    document.addEventListener("DOMContentLoaded", init);
    
    // Cleanup on page unload
    window.addEventListener("beforeunload", cleanup);
  </script>